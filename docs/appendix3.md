# P4和NPC++

### **NPC++ 与 P4 语言共有功能特性**

| **功能类别** | **功能描述** | **NPC++ 对应实现** | **P4 对应实现** |
| --- | --- | --- | --- |
| 报文解析 | 定义协议头格式，通过状态机解析报文协议头序列 | 用 NPCHeader 定义协议头，@parser 注解函数实现解析状态机，支持 _extract 提取字段 | 用 header 定义协议头，parser 结构体实现状态机，支持 extract 提取字段 |
| 匹配表机制 | 支持多种匹配类型，实现路由、ACL、流表等功能 | 提供 linear（index）、exact、lpm、ternary 四种表类型，内置 _lookup 等操作 | 提供 exact、lpm、ternary 等表类型，通过 table 结构体定义，支持 lookup 操作 |
| 控制流逻辑 | 定义报文处理的跳转、条件判断、表调用流程 | @control 注解函数描述控制流，支持条件语句、表实例化调用、报文转发 / 丢弃逻辑 | control 结构体定义处理逻辑，支持条件判断、表调用、apply 方法执行转发逻辑 |
| 报文编辑与转发 | 支持协议头增删改、报文发送、丢弃、复制等操作 | 提供 npc_pkt_add/set_valid 编辑报文，npc_pkt_send/drop/replicate 处理报文 | 支持 modify_field 编辑字段，send/drop 处理报文，部分目标支持报文复制 |
| 元数据处理 | 支持固有元数据（入端口、时间戳等）和自定义元数据，辅助报文处理 | 固有元数据 NPC_INTRINSIC_METADATA_S，自定义元数据 user-defined metadata | 固有元数据 standard_metadata_t，自定义元数据 metadata 结构体 |
| 类型系统 | 强类型，支持基本类型、复合类型（结构体、枚举）、自定义类型 | 基本类型 uint<W>，复合类型 struct/union/enum，typedef 自定义别名 | 基本类型 bit<W>/varbit<W>，复合类型 struct/enum，typedef 自定义别名 |
| 控制面交互 | 支持控制面对表项的增删改查，提供自动化部署和控制面接口 | 生成 npc_table_info.json，控制面接口 NDI 支持表项操作 | 通过 P4Runtime 协议实现控制面交互，支持表项动态配置 |

### **NPC++ 与 P4 语言不同功能特性**

### **1. NPC++**

- **线程模型**：支持main 主线程 + 背景线程（通过 NPCProgram 声明非 main 线程），可实现定时任务、自发包等后台逻辑。（后续应该可以以主线程1份代码为主）
- **多段解析**：支持拆分超过 128B 的报文为多段解析，每段对应独立parser 和 control，全局变量共享但协议头仅当前段可见。（报文限制）
- **特有编程接口**：内置Fifo（先进先出队列）、Lock（锁操作）、Counter（计数器）、CAR（流量控制）等硬件级 API。（这些没有）
- **深度报文解析**：提供npc_pkt_get_data/get_next_data 等接口，可直接获取未经 parser 解析的报文原始数据，支持报文窗回滚（npc_pkt_rewind）。（禁用相关接口）
- **控制面接口 NDI**：自定义控制面接口规范，支持表项自动化部署、场景化性能配置（json）。（禁用相关接口）
- **特有注解与版本控制**：支持@app_version 注解设置版本号，编译器将版本信息写入二进制文件。（不需要相关功能）
- **CPU / 环回交互**：提供npc_transinfo_get/set 接口，支持与 CPU、环回口的报文交互及 TRANS_HDR 头编辑。（这部分考虑下如何修改或者其他方式）

### **2. P4**

- **目标无关抽象**：P4 代码可适配不同硬件架构（如 ASIC、FPGA、软件交换机），NPC++ 主要针对特定网络处理器架构。（NPC++支持P4后可以支持异构）
- **extern 机制**：通过extern 关键字适配硬件特有功能，具有更强的扩展性和兼容性。（扩展性方面）
- **标准控制面协议**：原生支持P4Runtime 标准协议，无需自定义控制面接口。
- **更灵活的 parser 模型**：P4 支持transition 动态跳转、select 多条件匹配，NPC++ parser 依赖 switch 表达式固定跳转。（这方面转换需要注意下）

### **NPC++ 需限制 / 调整的功能（以适配 P4 翻译）**

| **需限制的 NPC++ 功能** | **限制原因** | **适配方案** |
| --- | --- | --- |
| 背景线程（非 main 线程） | P4 无多线程模型，仅支持单报文单流程处理 | 移除背景线程，将定时任务、自发包逻辑迁移至控制面或通过 P4 extern 模拟 |
| 多段解析机制 | P4 的 parser 为单一状态机，不支持分段解析与跨段协议头隔离 | 重构为单段 parser，通过状态机扩展支持长报文解析，协议头全局可见 |
| 特有编程接口（Fifo/Lock/Counter） | P4 无原生对应 API，需通过 extern 适配 | 注意使用 |
| 深度报文解析接口（get_data/rewind） | P4 的 parser 需提前定义协议头格式，不支持动态读取原始报文数据 | 移除动态读取逻辑，所有协议头通过 parser 显式解析，提前定义完整协议结构 |
| 控制面接口 NDI | P4 原生支持 P4Runtime，无需自定义接口 | 替换为 P4 标准表项定义，移除 npc_table_info.json/CodeCfg.json 相关配置 |
| 特有注解（@app_version） | P4 无对应注解机制 | 移除版本注解，版本信息通过控制面或编译参数管理 |
| 跨报文状态维护（全局变量） | NPC++ 全局变量生命周期与报文绑定，P4 不允许跨报文维护状态（除 register） | 限制全局变量仅用于单报文内部传递 |
| CPU / 环回交互特有接口 | P4 通过 standard_metadata_t 处理端口类型，无 TRANS_HDR 专用接口 | 替换为 P4 端口类型判断（standard_metadata.ingress_port），移除 transinfo 接口 |

### 一、 核心物理性能指标 (Core Physical Performance)

| **指标名称** | **严谨定义与典型量级** | **实验意义与底层原理** |
| --- | --- | --- |
| **吞吐量 (Throughput)** | 单位：Tb/s 或 Gbps。高性能芯片（如 Tofino）单片可达 6.4Tb/s。 | 验证 P4 程序在高带宽负载下是否丢包，是评估系统容量的核心。 |
| **转发速率 (Forwarding Rate)** | 单位：B pps（十亿包每秒）。典型峰值约 4.8B pps。 | 衡量交换机在处理小包（如 64B）时的包处理极限。 |
| **延迟 (Latency)** | 单位：ns 或 $\mu$s。硬件中通常低于 400ns。 | 反映数据包经过解析（Parser）、匹配-动作流水线到去解析（Deparser）的总耗时。 |
| **抖动 (Jitter)** | 延迟的变化程度。在 5G 和实时流媒体实验中尤为重要。 | 衡量系统在多任务并发或拥塞时的稳定性。 |
| **功耗 (Power Draw)** | 每端口平均功耗（如 4.2W）。 | 评估可编程逻辑相对于固定功能交换机的能效比。 |

### 二、 硬件资源与架构指标 (Resource & Architectural Metrics)

由于 PISA（协议无关交换架构）的内存和计算单元是极其有限的，资源的消耗程度直接决定了程序的可行性。

1. **SRAM/TCAM 占用率：**
    - **原理：** SRAM 用于存储精确匹配表、计数器和寄存器；TCAM 用于通配符或范围匹配。
    - **指标：** 衡量流表项的最大容量（Flow Capacity），例如系统能支持多少万条 NAT 或隧道条目。
2. **流水线阶段数 (Pipeline Stages)：**
    - **原理：** 硬件 ASIC 被划分为多个 Stage（通常为 12 个左右），每个 Stage 只能执行有限的操作。
    - **指标：** 评估 P4 代码逻辑深度，若超出 Stage 限制则无法编译到硬件。
3. **ALU 资源比：** 衡量在每个 Stage 内进行的算术逻辑运算（如哈希计算、加减法）的密集度。
4. **表项更新延迟 (Update Latency)：** 2024 年最新研究关注的指标，指从控制面下发规则到数据面正式生效的耗时（$\mu$s 级），影响动态路由的收敛速度。

### 三、 网络遥测与状态度量 (Telemetry & State Metrics)

P4 的核心优势在于带内网络遥测（INT），这使得实验可以获取传统网络无法触达的微观指标。

- **队列占用率 (Queue Occupancy)：** 实时监控交换机出口队列的深度，用于检测导致丢包的“微突发”（Microbursts）流量。
- **链路利用率 (Link Utilization)：** 配合动态负载均衡实验，评估网络整体流量分布的平衡度。
- **流完成时间 (Flow Completion Time, FCT)：** 尤其在拥塞控制实验（如 HPCC 协议）中，是衡量网络对不同大小流处理效率的关键。
- **测量准确度 (Accuracy)：** 针对使用 Sketch（草图算法）的测量程序，需对比其估算值与真实值之间的相对误差（Relative Error）。

### 四、 针对特定应用的进阶指标 (Application-Specific Metrics)

现代 P4 研究已深入到计算加速领域，引入了交叉学科的评价体系。

| **应用领域** | **关键评估指标** | **说明** |
| --- | --- | --- |
| **负载均衡 (LB)** | 连接一致性 (PCC) | 在服务器池变动时，确保同一流的包始终打向同一后端服务器。 |
| **内网缓存 (Caching)** | 缓存命中率、每秒查询数 (BQPS) | 衡量如 NetCache 等方案在缓解后端数据库“热点”问题上的效能。 |
| **内网计算 (ML加速)** | 训练加速比、推理延迟 | 衡量 SwitchML 等方案在执行分布式机器学习梯度聚合时的通信节省率。 |
| **电信服务 (5G)** | 切换时间 (Handover Time)、MOS 评分 | 评估 P4 交换机在移动边缘计算中维持业务连续性和语音质量的能力。 |